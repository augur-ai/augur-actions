name: "Augur Security Scan"
description: "Universal security scanner with CodeQL auto-detection and JSON webhook notifications"
author: "augur-ai"

inputs:
  api_url:
    description: "Base URL for the Augur API"
    required: false
  api_key:
    description: "API key for authentication"
    required: false
  feed_id:
    description: "Feed ID for notifications"
    required: false
  languages:
    description: "Languages to scan (auto-detect if not specified)"
    required: false
    default: ""
  fail_on_issues:
    description: "Fail workflow if security issues found"
    required: false
    default: "false"

outputs:
  results_count:
    description: "Number of security findings"
    value: ${{ steps.scan.outputs.results_count }}
  status:
    description: "Scan status (success/failed)"
    value: ${{ steps.scan.outputs.status }}
  languages_detected:
    description: "Languages that were scanned"
    value: ${{ steps.scan.outputs.languages_detected }}
  feed_status:
    description: "Augur feed update status"
    value: ${{ steps.feed-update.outputs.success }}

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      id: init
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ inputs.languages }} # Auto-detects if empty
      continue-on-error: true

    - name: Autobuild
      id: autobuild
      uses: github/codeql-action/autobuild@v3
      continue-on-error: true

    - name: Perform CodeQL Analysis
      id: analyze
      uses: github/codeql-action/analyze@v3
      with:
        output: sarif-results
        upload: false
      continue-on-error: true

    - name: Process Results and Send Webhook
      id: scan
      shell: bash
      run: |
        echo "üîí Processing Augur Security Scan Results..."

        # Check if CodeQL steps succeeded
        CODEQL_SUCCESS="true"
        if [[ "${{ steps.init.outcome }}" != "success" || "${{ steps.autobuild.outcome }}" != "success" || "${{ steps.analyze.outcome }}" != "success" ]]; then
          CODEQL_SUCCESS="false"
          echo "‚ö†Ô∏è CodeQL analysis failed or was skipped - using fallback scan"
          echo "  - Init: ${{ steps.init.outcome }}"
          echo "  - Autobuild: ${{ steps.autobuild.outcome }}"
          echo "  - Analyze: ${{ steps.analyze.outcome }}"
        fi

        # Find SARIF files
        SARIF_FILES=$(find sarif-results -name "*.sarif" 2>/dev/null || echo "")

        if [[ -z "$SARIF_FILES" || "$CODEQL_SUCCESS" == "false" ]]; then
          echo "‚ö†Ô∏è No SARIF files found or CodeQL failed - using fallback scan"
          
          # Simple fallback scan
          TOTAL_FILES=0
          TOTAL_FINDINGS=0
          LANGUAGES_FOUND=""
          
          # Check for different languages
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | head -1 | grep -q .; then
            JS_FILES=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | wc -l)
            TOTAL_FILES=$((TOTAL_FILES + JS_FILES))
            LANGUAGES_FOUND="javascript"
            
            # Basic JS security patterns
            EVAL_COUNT=$(grep -r "eval(" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . | wc -l || echo "0")
            INNERHTML_COUNT=$(grep -r "innerHTML" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . | wc -l || echo "0")
            TOTAL_FINDINGS=$((TOTAL_FINDINGS + EVAL_COUNT + INNERHTML_COUNT))
          fi
          
          if find . -name "*.py" | head -1 | grep -q .; then
            PY_FILES=$(find . -name "*.py" | wc -l)
            TOTAL_FILES=$((TOTAL_FILES + PY_FILES))
            [[ -n "$LANGUAGES_FOUND" ]] && LANGUAGES_FOUND="$LANGUAGES_FOUND,python" || LANGUAGES_FOUND="python"
            
            # Basic Python security patterns
            EXEC_COUNT=$(grep -r "exec(" --include="*.py" . | wc -l || echo "0")
            EVAL_COUNT=$(grep -r "eval(" --include="*.py" . | wc -l || echo "0")
            TOTAL_FINDINGS=$((TOTAL_FINDINGS + EXEC_COUNT + EVAL_COUNT))
          fi
          
          if find . -name "*.java" | head -1 | grep -q .; then
            JAVA_FILES=$(find . -name "*.java" | wc -l)
            TOTAL_FILES=$((TOTAL_FILES + JAVA_FILES))
            [[ -n "$LANGUAGES_FOUND" ]] && LANGUAGES_FOUND="$LANGUAGES_FOUND,java" || LANGUAGES_FOUND="java"
            
            # Basic Java security patterns
            RUNTIME_COUNT=$(grep -r "Runtime.getRuntime().exec" --include="*.java" . | wc -l || echo "0")
            TOTAL_FINDINGS=$((TOTAL_FINDINGS + RUNTIME_COUNT))
          fi
          
          SCAN_TYPE="fallback"
          
        else
          echo "üìÑ Found SARIF files, processing CodeQL results..."
          
          # Process all SARIF files
          TOTAL_FINDINGS=0
          LANGUAGES_FOUND=""
          
          for SARIF_FILE in $SARIF_FILES; do
            echo "Processing: $SARIF_FILE"
            
            # Count findings in this SARIF file
            FILE_FINDINGS=$(jq '[.runs[].results // []] | add | length' "$SARIF_FILE" 2>/dev/null || echo "0")
            TOTAL_FINDINGS=$((TOTAL_FINDINGS + FILE_FINDINGS))
            
            # Extract language from SARIF
            LANG=$(jq -r '.runs[0].tool.driver.name // "unknown"' "$SARIF_FILE" 2>/dev/null || echo "unknown")
            if [[ "$LANG" != "unknown" && "$LANG" != "null" ]]; then
              [[ -n "$LANGUAGES_FOUND" ]] && LANGUAGES_FOUND="$LANGUAGES_FOUND,$LANG" || LANGUAGES_FOUND="$LANG"
            fi
            
            echo "  - Language: $LANG"
            echo "  - Findings: $FILE_FINDINGS"
          done
          
          # Remove duplicates from languages
          LANGUAGES_FOUND=$(echo "$LANGUAGES_FOUND" | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
          
          # Count total files scanned (estimate)
          TOTAL_FILES=$(find . -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.java" -o -name "*.go" -o -name "*.cs" -o -name "*.cpp" -o -name "*.c" | wc -l)
          
          SCAN_TYPE="codeql"
        fi

        echo ""
        echo "üìä Scan Summary:"
        echo "- Type: $SCAN_TYPE"
        echo "- Languages: ${LANGUAGES_FOUND:-"none detected"}"
        echo "- Files: $TOTAL_FILES"
        echo "- Findings: $TOTAL_FINDINGS"

        # Prepare SARIF data for feed update (handle large files carefully)
        SARIF_DATA="{}"
        if [[ "$SCAN_TYPE" == "codeql" && -n "$SARIF_FILES" ]]; then
          FIRST_SARIF=$(echo "$SARIF_FILES" | head -1)
          if [[ -f "$FIRST_SARIF" ]]; then
            # Check file size to avoid jq argument list issues
            SARIF_SIZE=$(wc -c < "$FIRST_SARIF" 2>/dev/null || echo "0")
            if [[ "$SARIF_SIZE" -lt 1048576 ]]; then  # Less than 1MB
              echo "üìÑ Including full SARIF data (${SARIF_SIZE} bytes)"
              SARIF_DATA=$(cat "$FIRST_SARIF" | jq -c . 2>/dev/null || echo '{}')
            else
              echo "‚ö†Ô∏è SARIF file too large (${SARIF_SIZE} bytes), including summary only"
              # Create a summary instead of full SARIF
              SARIF_DATA=$(jq -n --arg size "$SARIF_SIZE" '{"summary": "SARIF file too large for inclusion", "size_bytes": ($size | tonumber)}')
            fi
          fi
        fi

        # Create data variables for feed update using jq for proper JSON formatting
        # Use a temp file to avoid argument list issues
        echo "$SARIF_DATA" > sarif_temp.json

        jq -n \
          --arg repository "${{ github.repository }}" \
          --arg branch "${{ github.ref_name }}" \
          --arg commit "${{ github.sha }}" \
          --arg scan_type "$SCAN_TYPE" \
          --arg languages "${LANGUAGES_FOUND:-none}" \
          --arg total_files "$TOTAL_FILES" \
          --arg total_findings "$TOTAL_FINDINGS" \
          --arg workflow_run "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          --slurpfile sarif_data sarif_temp.json \
          '{
            repository: $repository,
            branch: $branch,
            commit: $commit,
            scan_type: $scan_type,
            languages: $languages,
            total_files: ($total_files | tonumber),
            total_findings: ($total_findings | tonumber),
            workflow_run: $workflow_run,
            sarif_data: $sarif_data[0]
          }' > feed_data.json

        # Clean up temp file
        rm -f sarif_temp.json

        echo "üìä Prepared security scan data for feed update"
        echo "üîç Feed data preview:"
        head -5 feed_data.json

        # Set outputs
        echo "results_count=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        echo "languages_detected=${LANGUAGES_FOUND:-none}" >> $GITHUB_OUTPUT

        # Set feed_data output with proper escaping
        {
          echo 'feed_data<<EOF'
          cat feed_data.json
          echo 'EOF'
        } >> $GITHUB_OUTPUT

        # Final summary
        echo ""
        echo "üéØ Final Summary:"
        echo "Repository: ${{ github.repository }}"
        echo "Languages: ${LANGUAGES_FOUND:-none}"
        echo "Findings: $TOTAL_FINDINGS"
        echo "Scan Type: $SCAN_TYPE"
        if [[ "$CODEQL_SUCCESS" == "false" ]]; then
          echo "CodeQL Status: Failed (used fallback scan)"
        else
          echo "CodeQL Status: Success"
        fi

        # Only fail on issues if explicitly requested AND we have findings
        if [[ "${{ inputs.fail_on_issues }}" == "true" && $TOTAL_FINDINGS -gt 0 ]]; then
          echo "‚ùå Failing due to security findings (fail_on_issues=true)"
          exit 1
        fi

        if [[ "$CODEQL_SUCCESS" == "false" ]]; then
          echo "‚ö†Ô∏è Security scan completed with fallback (CodeQL issues ignored)"
        else
          echo "‚úÖ Security scan completed successfully!"
        fi

    - name: Send Augur Feed Update
      id: feed-update
      if: inputs.api_url != '' && inputs.api_key != '' && inputs.feed_id != ''
      uses: augur-ai/augur-actions/actions/augur-feed-update@main
      with:
        api_url: ${{ inputs.api_url }}
        api_key: ${{ inputs.api_key }}
        feed_id: ${{ inputs.feed_id }}
        event_type: "security_scan_completed"
        source: "github-security-scan"
        data_variables: ${{ steps.scan.outputs.feed_data }}
